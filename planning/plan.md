# 资金流转税务最优路径规划与沙盘推演系统 - 项目落地文档

## 1. 项目目的
本项目旨在开发一套自动化的财务税务寻优算法及可视化的沙盘推演系统。针对特定的企业与个人股权架构，在合规的前提下，规划设定的初始资金（如100万元）从两个源头（PXA、PXU）流向两个终点自然人（SZW、SXP）的税务路径。
核心目标双管齐下：
1. **逆向寻优 (Reverse Optimization):** 通过算法动态评估不同资金流转方式的税费损耗，自动寻找使目标自然人税后净到手总额最大化的最优分配策略。
2. **正向推演与对比 (Forward Simulation & Comparison):** 提供前端交互界面，允许人类业务专家手动输入假设的资金分配数值，程序将基于输入正向计算出税耗和最终净值，并与算法得出的最优解进行直观的对比分析，辅助管理层决策。

## 2. 核心业务规则与约束汇总
* **网络拓扑 (无环图):** 资金只能正向流动或直接到达终点。涉及节点包括公司（PXA, PXU, KKG, PYU）、合伙企业（HHY，作为 Pass-through 实体）以及自然人（SZW, SXP）。
* **金额单位与精度:**
    * 单位为元。
    * **强制精度:** 后端计算全程强制使用 `decimal.Decimal` 类型，严禁使用 float。
    * **舍入规则:** 采用“银行家舍入” (`ROUND_HALF_EVEN`)。
    * 任意一步“摩擦/扣减”发生后，金额按小数点后 4 位进行 round。
    * 所有终点净到手与汇总指标最终展示到“元”。
* **资金摩擦力 (税耗):**
    * **增值税 (VAT):**
        * VAT 税率由主体的 VAT 属性决定，作为输入项由人类维护：一般纳税人 6%，小规模纳税人 3%。
        * VAT 为价外税，计算方式：
            * `vat_amount = price_gross / (1 + vat_rate) * vat_rate`
        * 附加税率随主体不同而不同，作为输入项由人类维护：
            * `surtax_amount = vat_amount * surtax_rate`
        * VAT 不可抵扣成本默认作用于所有边；可配置为仅对部分边不可抵扣。
    * **税前流转 (Pre-tax Transfer):**
        * 发送方通过“作为成本抵扣税前利润”降低应纳税所得额，从而产生 EIT 节税效果。
        * 本次流转对应的交易对价以现金“价税合计”口径记为 `price_gross`；VAT 与附加税计入本次交易的税耗。
    * **税后流转 (Post-tax Transfer):**
        * 税率从数据库加载并由规则版本控制。
        * 自然人 20% 税率均按股息红利所得口径处理。
        * VAT/EIT/PIT 在同一笔资金流转中不并行叠加扣缴情形。
* **终点计税特例:**
    * **综合所得累进税率:** 3% - 45% 累进税率适用于综合所得（工资薪金所得、劳务所得）。
    * **工资薪金特别奖金计税:** 属于工资薪金的特殊计税规则，以函数形式封装供调用。
    * **SZW 合并计税范围:** 仅对“工资薪金（不含特别奖金计税部分）+ 劳务所得”合并计为综合所得；股息红利所得单独计税，不与综合所得合并。
    * **SXP (独立镜像):** 综合所得按 3% - 45% 累进税率；股息红利按 20%；与 SZW 不合并。
* **税种发生点:** VAT/EIT/PIT 均在发出资金的一边确定并在发出时扣减；不存在单笔同时扣缴 VAT 和 EIT/PIT。
* **流动性约束:** 任意两个关联主体之间，“税前模式”年度累计转移资金规模上限为 **50 万元**。
    * **合规提示 (Soft Block):** 当人工输入的流转金额超过此上限时，系统不进行硬性阻断，但需在界面给予强烈的合规风险提示。
* **初始资金:** 初始总资金为 100 万元，满足 `PXA_init + PXU_init = 1,000,000`，由寻优算法决定在两个源头之间的最优分配。
* **资金守恒:** 各节点不留存资金（所有入账资金需按规则完全分配至下一层或终点）。
* **目标函数:** 最大化 SZW 与 SXP 的**合计**税后净到手金额（不考虑两者分配比例的公平性，仅追求总和最大）。

## 3. 规划的技术方案

本系统采用前后端分离架构，核心是一个**带状态和容量约束的有向无环图 (DAG) 连续分配推演引擎**。

### 3.1 数据与配置来源（规则版本化）
* **规则参数由数据库提供:** VAT 主体属性、VAT 税率、附加税率、EIT/PIT 税率、以及其他主体属性由数据库维护，程序通过 SQL 拉取。
* **规则引擎解耦:** 采用**策略模式 (Strategy Pattern)** 将税率计算、阈值判断（如 50 万）、奖金计税等逻辑抽象为独立策略类，避免硬编码，便于未来热更新。
* **主体层级字段:** 在 `company.db` 中为主体增加“层级 level”字段，用于约束资金每次仅允许向下流转 1 级或直接流入终点自然人。
* **规则版本控制:** 所有税率与口径参数需带版本号，以支持结果回放与审计。

### 3.2 HHY（Pass-through）穿透规则的表达方式
* **不依赖 AI 决策合规与可行性:** 可行性必须由显式规则与约束表达，AI 仅可用于辅助生成方案解释或填充配置草案。
* **建议在 DB 增加 JSON 规则字段:** 用结构化字段明确“穿透分配方式、所得性质、是否并入综合所得”等口径，供引擎严格执行。
* **建议 JSON 字段最小集合:**
    * `allocations`: 分配到各自然人的比例/份额。
    * `income_nature`: 每类流入的所得性质（综合所得/股息红利/其他）。
    * `merge_policy`: 是否并入 SZW 综合所得、是否适用奖金特别计税等规则开关。
    * `validation_rules`: 结构性约束（例如不得出现某些路径、比例范围等）。

### 3.3 引擎分层（先准后快）
* **确定性正向引擎（对账优先）:**
    * 输入：资金流向矩阵（或等价的边列表）、每条边的流转模式（税前/税后/分红/奖金等）、规则版本。
    * 输出：逐边税耗拆解、各节点税基变化、终点个税计算明细、汇总指标（SZW/SXP 净到手、总税耗、有效税率）。
* **逆向寻优引擎（可控近似）:**
    * **算法选择:** 优先采用**带步长的网格搜索 (Grid Search)** 或 **差分进化算法 (Differential Evolution)**，应对非线性、非凸的目标函数。
    * 采用“关键决策变量搜索 + 正向引擎评估”的两层策略作为默认方案；在必要时可降级为离散化 DP/DFS 作为基线实现。
    * 逆向寻优必须支持：步长配置、超时配置、返回当前最优解与可复现输入（规则版本+参数快照）。
    * 对外口径：输出为“在给定步长与约束下的最优/近似最优”，不默认宣称数学全局最优。
* **前端交互逻辑:**
    * “人工测算”与“系统寻优”并排展示；人工输入实时调用正向引擎得到账单，并与寻优结果对比。
    * **方案快照:** 支持用户保存当前的人工测算方案（Snapshot），并进行多方案横向对比。
    * 可视化输出：资金流向桑基图（支持节点下钻）、税耗分布对比图、关键指标卡片。

## 4. 技术栈
* **后端语言与框架:** Python 3.10+ 搭配 **FastAPI** (用于快速构建高性能的异步 API 接口，连接前端与计算逻辑)。
* **算法与数据结构 (后端):** `decimal` (高精度货币计算), `dataclasses` (构建财务实体和状态对象), `functools.lru_cache` (加速搜索), `pydantic` (严格校验前端传入的人工假设数据)。
* **前端展示:** **Vue.js 3** (搭配 Element Plus 等 UI 库构建表单和数据面板)。
* **图表可视化:** Apache ECharts 或 Chart.js，用于绘制资金流向桑基图 (Sankey Diagram) 和税耗对比柱状图。

## 5. 分步骤落地路线

### 第一阶段：税务计算引擎与实体构建 (Tax Engine & Models)
* **任务:** 编写纯函数处理终点个人的复杂计税，并将财务主体与业务约束抽象为对象。
* **交付物:**
    * `calc_progressive_tax(amount)`: 综合所得 3% - 45% 累进税率计算 (**使用 Decimal**)。
    * `calc_bonus_tax(bonus_amount)`: 工资薪金特别奖金计税 (**使用 Decimal**)。
    * `calc_dividend_tax(amount)`: 股息红利 20% 计税。
    * `calc_vat(price_gross, vat_rate)`: 价外税 VAT 计算。
    * `calc_surtax(vat_amount, surtax_rate)`: 附加税计算。
    * `calc_edge_friction(sender, receiver, amount, mode, rule_snapshot)`: 计算单边流转的税耗与净额，并执行 `ROUND_HALF_EVEN`。
    * `Entity` 和 `GlobalState` 类。

### 第二阶段：正逆向双引擎开发 (Forward & Reverse Engines)
* **任务:** 实现手动推演计算器与自动寻优算法。
* **交付物:**
    * **正向引擎:** `calculate_human_scenario(flow_matrix)`，验证人工输入是否满足：
        * 税前模式年度累计 50 万上限（按关联主体对汇总）。
        * “每次仅向下流转 1 级或直达终点”的层级约束。
        * 节点不留存（资金守恒）。
      并输出详细税耗账单与净值。
    * **逆向引擎:** `optimize_flow(state, step_size, time_limit)`，在给定步长与超时条件下输出最优/近似最优解与账单，不默认宣称数学全局最优。

### 第三阶段：API 接口封装 (API Layer)
* **任务:** 在 `main.py` 中通过 FastAPI 暴露接口。
* **交付物:**
    * `POST /api/simulate`: 接收人工测算参数，返回详细税耗账单。
    * `POST /api/optimize`: 触发寻优算法，返回最优资金流向矩阵及税耗账单。

### 第四阶段：前端交互与可视化页面开发 (Frontend Dashboard)
* **任务:** 开发供业务专家使用的 Web 界面。

* **交付物:**
    * **输入区:** 交互式表单/滑块，用于设定 PXA/PXU 的初始分配以及各层级的流转模式（税前/分红）。
    * **对比看板:** 并排显示“人工测算方案”与“系统最优方案”的关键指标（总发款、总税耗、SZW 净收、SXP 净收、整体有效税率）。
    * **路径可视化:** 渲染资金流向桑基图，直观展示资金在哪个节点发生了最大的“税耗漏损”。
