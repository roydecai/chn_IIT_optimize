# 项目落地步骤（详细版）

## 目标与范围
- 目标：在合规前提下，构建资金流转税务寻优与沙盘推演系统，实现“逆向寻优 + 正向推演对比”两条主线。
- 范围：税务规则与主体建模、正逆向计算引擎、API 服务、前端交互与可视化、规则版本化与回放。

## 总体阶段划分
1. 规则与数据基建
2. 税务计算引擎与领域模型
3. 正向推演引擎
4. 逆向寻优引擎
5. API 层封装
6. 前端交互与可视化
7. 质量验证与交付

## 详细落地步骤
### 1) 规则与数据基建
- 明确主体清单、主体层级与流转限制（含“只允许向下 1 级或直达终点”）。
- 设计规则版本化策略，定义规则快照字段范围与存储形式。
- 设计 HHY 穿透规则 JSON 字段与校验策略（allocations、income_nature、merge_policy、validation_rules）。
- 明确 VAT 主体属性、VAT 税率、附加税率、EIT/PIT 税率等字段的维护口径与更新流程。
- 产出：规则字段清单、规则版本化说明、HHY 穿透 JSON 规范。

### 2) 税务计算引擎与领域模型
- 建立统一金额与精度规范：全链路 Decimal、ROUND_HALF_EVEN、税耗后四位 round。
- 实现个人所得税与特殊计税的独立计算函数（综合所得累进、奖金特别计税、股息红利）。
- 实现 VAT、附加税、税前/税后流转的基础计算。
- 定义 Entity 与 GlobalState 领域对象，封装主体属性、税率与税基状态。
- 产出：税务计算函数集合、领域模型与基础校验规则。

### 3) 正向推演引擎
- 输入：资金流向矩阵或边列表、流转模式、规则版本快照。
- 校验：资金守恒、层级约束、税前模式 50 万利规提示。
- 输出：逐边税耗拆解、节点税基变化、终点税负明细、总体指标汇总。
- 产出：正向推演引擎与结果结构定义。

### 4) 逆向寻优引擎
- 采用“决策变量搜索 + 正向引擎评估”的双层策略。
- 支持步长配置、超时配置、最优解与规则快照输出。
- 输出口径：在给定步长与约束下的最优/近似最优结果。
- 产出：寻优引擎与可回放输入/输出结构。

### 5) API 层封装
- 暴露模拟与寻优接口，统一输入校验与错误码规范。
- 对接规则版本与快照参数，确保结果可复现。
- 产出：/api/simulate 与 /api/optimize 接口定义与文档。

### 6) 前端交互与可视化
- 实现人工测算表单与参数快照保存能力。
- 与系统最优方案并排对比展示关键指标。
- 桑基图与税耗对比图展示资金路径与税损分布。
- 产出：前端页面与可视化组件结构。

### 7) 质量验证与交付
- 规则与计算一致性校验（与样例对账）。
- 逆向寻优结果复现校验（规则版本快照回放）。
- 端到端流程验证（人工测算与系统寻优一致输出）。
- 产出：测试用例清单、验收清单、上线交付包。

## 里程碑与验收口径
- M1：规则字段与版本化方案确认、穿透规则结构定稿。
- M2：税务计算与领域模型稳定，正向推演可对账。
- M3：逆向寻优可输出稳定方案并可回放。
- M4：API 与前端联调完成，可进行方案对比与可视化展示。
- M5：验收与交付完成。
